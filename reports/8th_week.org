#+TITLE: Report for : Un intergiciel d’une base de données NewSQL qui considère la localité de l’application cliente -- 8th week --
#+AUTHOR: Marie Delavergne


* Monday 5 March [2018-03-05 lun.]

- Trying to do everything from scratch
  + No problem with ~openstack~ task, but I will be making the deployment in two steps anyway
  + A bit long, but rally is mostly working
#+BEGIN_EXAMPLE
root@grisou-20:~# docker ps -a
CONTAINER ID        IMAGE                              COMMAND                  CREATED             STATUS                   PORTS                                              NAMES
4c6bbc23611f        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 hours ago         Exited (0) 2 hours ago                                                      get-entities.yaml-11-43-05
caf8c993d72e        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 hours ago         Exited (0) 2 hours ago                                                      create-user.yaml-11-37-09
0a87ef95bc84        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 hours ago         Exited (0) 2 hours ago                                                      create-user-update-password.yaml-11-18-33
bd5177735251        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 hours ago         Exited (2) 2 hours ago                                                      create-user-set-enabled-and-delete.yaml-11-02-30
8eef33d2cd84        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (2) 2 hours ago                                                      create-update-and-delete-tenant.yaml-11-01-06
b737c7d2ff4b        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-tenant.yaml-11-00-30
3bea5b7babfb        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-tenant-with-users.yaml-10-52-57
23aa550ca5b1        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-update-user.yaml-10-51-53
7397884c7a75        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-list-users.yaml-10-43-02
2f90b223672b        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-list-tenants.yaml-10-42-28
46cdf3e4714c        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-list-services.yaml-10-41-24
3007d8108350        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-list-roles.yaml-10-40-56
ba33625c1a16        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-list-ec2credentials.yaml-10-40-23
8d8f3344d284        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-get-role.yaml-10-39-49
b6578eb3c2f5        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-delete-user.yaml-10-35-50
6a90270508b7        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-delete-service.yaml-10-33-10
92b0888afaad        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-delete-role.yaml-10-32-24
d5b13158f3ad        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-delete-ec2credential.yaml-10-31-57
cfe9a5767de8        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-add-and-list-user-roles.yaml-10-27-44
8b80162c12da        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      authenticate-user-and-validate-token.yaml-10-26-42
568b1c90e85a        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      add-and-remove-user-role.yaml-10-20-06



0a0e6501f8ad        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 hours ago         Exited (2) 2 hours ago                                                        get-entities.yaml-11-47-53
b9da8a4b8b73        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 hours ago         Exited (0) 2 hours ago                                                        create-user.yaml-11-38-22
ce27dc23969c        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 hours ago         Exited (2) 2 hours ago                                                        create-user-update-password.yaml-11-22-58
d30ab6dc7107        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 hours ago         Exited (2) 2 hours ago                                                        create-user-set-enabled-and-delete.yaml-11-08-41
331a038126f6        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 hours ago         Exited (0) 2 hours ago                                                        create-update-and-delete-tenant.yaml-11-02-59
440af1662adc        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 hours ago         Exited (0) 2 hours ago                                                        create-tenant.yaml-11-01-41
56ad10810a65        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 2 hours ago                                                        create-tenant-with-users.yaml-10-53-45
c23f79ba3e56        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                        create-and-update-user.yaml-10-52-07
cdc99a036ff1        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                        create-and-list-users.yaml-10-44-16
20ea883666fe        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                        create-and-list-tenants.yaml-10-43-17
e20584faaa39        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                        create-and-list-services.yaml-10-41-25
1b91195d7380        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                        create-and-list-roles.yaml-10-40-51
b23fd78e5e18        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                        create-and-list-ec2credentials.yaml-10-40-14
38624b757e01        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (201) 3 hours ago                                                      create-and-get-role.yaml-10-40-08
1ae03daf1110        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                        create-and-delete-user.yaml-10-37-34
eb22ca21ff26        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                        create-and-delete-service.yaml-10-34-28
8a76f0344c12        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                        create-and-delete-role.yaml-10-33-12
0de9b651865a        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                        create-and-delete-ec2credential.yaml-10-32-30
e65e7e70125c        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                        create-add-and-list-user-roles.yaml-10-26-25
5a08d4997316        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                        authenticate-user-and-validate-token.yaml-10-26-15
6bf7cb52e83c        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                        add-and-remove-user-role.yaml-10-20-06


95562226cb12        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 hours ago         Exited (0) 2 hours ago                                                      get-entities.yaml-11-42-10
198282939ddf        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 hours ago         Exited (0) 2 hours ago                                                      create-user.yaml-11-37-01
879eac53060f        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 hours ago         Exited (2) 2 hours ago                                                      create-user-update-password.yaml-11-21-24
9dfd9bf9ce25        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 hours ago         Exited (2) 2 hours ago                                                      create-user-set-enabled-and-delete.yaml-11-03-19
76f1c922500a        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (2) 2 hours ago                                                      create-update-and-delete-tenant.yaml-11-01-35
2d269aca405c        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-tenant.yaml-11-00-38
a03cd707588a        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-tenant-with-users.yaml-10-53-32
1827f094f052        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-update-user.yaml-10-51-55
6ae6c3153281        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-list-users.yaml-10-43-19
c3b0478bcb50        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-list-tenants.yaml-10-42-56
6bfdbcf008a3        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-list-services.yaml-10-41-25
a546118b63f1        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-list-roles.yaml-10-40-12
cc3a03e07300        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-list-ec2credentials.yaml-10-39-47
6299f68bff27        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-get-role.yaml-10-38-20
7ff835d5190d        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-delete-user.yaml-10-33-11
b54083af4718        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-delete-service.yaml-10-32-19
b30d763d070a        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-delete-role.yaml-10-31-52
c837b6887030        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-and-delete-ec2credential.yaml-10-31-21
1ad3c785b14d        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      create-add-and-list-user-roles.yaml-10-26-34
149de24ce481        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      authenticate-user-and-validate-token.yaml-10-26-18
28dbc4d77a3a        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 hours ago         Exited (0) 3 hours ago                                                      add-and-remove-user-role.yaml-10-20-06

#+END_EXAMPLE
  + Got some bugs around readwithinuncertaintyintervalerror and
#+BEGIN_EXAMPLE
ConnectTimeout: Request to http://172.16.72.20/identity/v3/users/0e828c6d64014a3aa7ae7c39769f139f timed out

Traceback (most recent call last):
 File "/usr/local/lib/python2.7/dist-packages/rally/task/runner.py", line 71, in _run_scenario_once
   getattr(scenario_inst, method_name)(**scenario_kwargs)
 File "/usr/local/lib/python2.7/dist-packages/rally/plugins/openstack/scenarios/keystone/basic.py", line 90, in run
   self.admin_keystone.delete_user(user.id)
 File "/usr/local/lib/python2.7/dist-packages/rally/task/service.py", line 116, in wrapper
   return func(instance, *args, **kwargs)
 File "/usr/local/lib/python2.7/dist-packages/rally/plugins/openstack/services/identity/identity.py", line 109, in delete_user
   self._impl.delete_user(user_id)
 File "/usr/local/lib/python2.7/dist-packages/rally/plugins/openstack/services/identity/keystone_common.py", line 31, in delete_user
   return self._impl.delete_user(user_id)
 File "/usr/local/lib/python2.7/dist-packages/rally/plugins/openstack/services/identity/keystone_common.py", line 103, in delete_user
   self._clients.keystone(self.version).users.delete(user_id)
 File "/usr/local/lib/python2.7/dist-packages/keystoneclient/v3/users.py", line 296, in delete
   user_id=base.getid(user))
 File "/usr/local/lib/python2.7/dist-packages/keystoneclient/base.py", line 75, in func
   return f(*args, **new_kwargs)
 File "/usr/local/lib/python2.7/dist-packages/keystoneclient/base.py", line 426, in delete
   self.build_url(dict_args_in_out=kwargs))
 File "/usr/local/lib/python2.7/dist-packages/keystoneclient/base.py", line 219, in _delete
   return self.client.delete(url, **kwargs)
 File "/usr/local/lib/python2.7/dist-packages/keystoneauth1/adapter.py", line 319, in delete
   return self.request(url, 'DELETE', **kwargs)
 File "/usr/local/lib/python2.7/dist-packages/keystoneauth1/adapter.py", line 463, in request
   resp = super(LegacyJsonAdapter, self).request(*args, **kwargs)
 File "/usr/local/lib/python2.7/dist-packages/keystoneauth1/adapter.py", line 189, in request
   return self.session.request(url, method, **kwargs)
 File "/usr/local/lib/python2.7/dist-packages/keystoneauth1/session.py", line 698, in request
   resp = send(**kwargs)
 File "/usr/local/lib/python2.7/dist-packages/keystoneauth1/session.py", line 763, in _send_request
   raise exceptions.ConnectTimeout(msg)
ConnectTimeout: Request to http://172.16.72.20/identity/v3/users/0e828c6d64014a3aa7ae7c39769f139f timed out
#+END_EXAMPLE


- Trying to see how to make a collectd plugin for Cockroach using [[https://github.com/signalfx/integrations/blob/master/collectd-postgresql/10-postgresql.conf][this project]] but Ronan tells me it's better to ask Cockroachdb guys to make it since it would be useful for a lot of people


- Trying to see if =mysql.conf.j2= needs ~inventory_hostname~ or if I keep ~dbmaster_node~
  + deploying with mariadb after ~backup~ and ~destroy~, checking endpoints using ~docker run --rm -it mariadb mysql -h 172.16.72.20 -u root -p~
#+BEGIN_EXAMPLE
MariaDB [(none)]> SELECT * from keystone.endpoint;
+----------------------------------+--------------------+-----------+----------------------------------+------------------------------+-------+---------+-----------+
| id                               | legacy_endpoint_id | interface | service_id                       | url                          | extra | enabled | region_id |
+----------------------------------+--------------------+-----------+----------------------------------+------------------------------+-------+---------+-----------+
| 3e3102cb25f74091a23d001bb1cc86ca | NULL               | admin     | 220cb7fca5bb493693e5918b17babc6b | http://172.16.72.20/identity | {}    |       1 | grisou-20 |
| 69cbb635f84345c38e1145239f59cff7 | NULL               | admin     | 220cb7fca5bb493693e5918b17babc6b | http://172.16.72.3/identity  | {}    |       1 | grisou-3  |
| 798b25903cd64cd9a0a05a904bddea4d | NULL               | public    | 220cb7fca5bb493693e5918b17babc6b | http://172.16.72.3/identity  | {}    |       1 | grisou-3  |
| 88ff5ca8ae2d4650ad01a29ab6939dc5 | NULL               | public    | 220cb7fca5bb493693e5918b17babc6b | http://172.16.72.14/identity | {}    |       1 | grisou-14 |
| 9a8724755a744677b8f6d031b7da5d2c | NULL               | public    | 220cb7fca5bb493693e5918b17babc6b | http://172.16.72.20/identity | {}    |       1 | grisou-20 |
| c05cff00dcae4ec29e7d70517f202de1 | NULL               | admin     | 220cb7fca5bb493693e5918b17babc6b | http://172.16.72.14/identity | {}    |       1 | grisou-14 |
+----------------------------------+--------------------+-----------+----------------------------------+------------------------------+-------+---------+-----------+
#+END_EXAMPLE
  + mysql plugin keeps informations about the cluster, so there is no need to change this

- Searching how to add latency to the network
  + Changed the conf to add a network where only the databases are
  + Added the constraints to tc
    - emulates does not seem to take my constraint into account when launched
    - moreover, after changing the conf and doing an inventory, nothing seems changed, and after a deploy (even from scratch) I get =RTNETLINK answers: File exists=
    - trying to see if I can change a nic to UP since I get
      #+BEGIN_EXAMPLE
root@grisou-3:~# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
   link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
   inet 127.0.0.1/8 scope host lo
      valid_lft forever preferred_lft forever
   inet6 ::1/128 scope host
      valid_lft forever preferred_lft forever
2: eth4: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
   link/ether 24:6e:96:03:0b:fc brd ff:ff:ff:ff:ff:ff
3: eth5: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
   link/ether 24:6e:96:03:0b:fd brd ff:ff:ff:ff:ff:ff
4: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc htb state UP group default qlen 1000
   link/ether 24:6e:96:03:0b:f8 brd ff:ff:ff:ff:ff:ff
   inet 172.16.72.3/20 brd 172.16.79.255 scope global eth0
      valid_lft forever preferred_lft forever
   inet6 fe80::266e:96ff:fe03:bf8/64 scope link
      valid_lft forever preferred_lft forever
5: eth1: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
   link/ether 24:6e:96:03:0b:fa brd ff:ff:ff:ff:ff:ff
6: eth2: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
   link/ether a0:36:9f:7e:4b:88 brd ff:ff:ff:ff:ff:ff
7: eth3: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
   link/ether a0:36:9f:7e:4b:8a brd ff:ff:ff:ff:ff:ff
      #+END_EXAMPLE
    - and worse, in the env file, I have
  #+BEGIN_EXAMPLE
 control:
 - !!python/object:enoslib.host.Host
   address: grisou-48.nancy.grid5000.fr
   alias: grisou-48.nancy.grid5000.fr
   extra:
     control_network: eth0
     database_network: eth0
     enos_devices: [eth0, eth0]
   keyfile: null
   port: null
   user: root
 database:
 - !!python/object:enoslib.host.Host
   address: grisou-28.nancy.grid5000.fr
   alias: grisou-28.nancy.grid5000.fr
   extra:
     control_network: eth0
     database_network: eth0
     enos_devices: [eth0, eth0]
   keyfile: null
   port: null
   user: root
 - !!python/object:enoslib.host.Host
   address: grisou-4.nancy.grid5000.fr
   alias: grisou-4.nancy.grid5000.fr
   extra:
     control_network: eth0
     database_network: eth0
     enos_devices: [eth0, eth0]
   keyfile: null
   port: null
   user: root
 - !!python/object:enoslib.host.Host
   address: grisou-3.nancy.grid5000.fr
   alias: grisou-3.nancy.grid5000.fr
   extra:
     control_network: eth0
     database_network: eth0
     enos_devices: [eth0, eth0]
   keyfile: null
   port: null
   user: root
  #+END_EXAMPLE
  - when using [[https://github.com/BeyondTheClouds/enoslib/blob/978a3431c0d4dbae5621e1de08fc5858720238c8/enoslib/infra/enos_g5k/provider.py#L139][local-kvlan]], I can't access the machines and the deployment, after deploying debian on 4 nodes, only consider the control node which is not on the vlan.
  - will try tomorrow on a routed vlan (kavlan)


* Tuesday 6 March [2018-03-06 mar.]

- Trying with kavlan while searching how to configure it

#+BEGIN_EXAMPLE
DEBUG:root:Running ip link set eth0 up ; dhclient eth0 on ['grisou-47-kavlan-4.nancy.grid5000.fr', 'grisou-48-kavlan-4.nancy.grid5000.fr', 'grisou-26-kavlan-4.nancy.grid5000.fr']
DEBUG:root:Running ip link set eth0 up ; dhclient eth0 on ['grisou-49.nancy.grid5000.fr']
DEBUG:root:{'control': [Host(grisou-49.nancy.grid5000.fr, address=grisou-49.nancy.grid5000.fr)], 'database': [Host(grisou-47-kavlan-4.nancy.grid5000.fr, address=grisou-47-kavlan-4.nancy.grid5000.fr), Host(grisou-48-kavlan-4.nancy.grid5000.fr, address=grisou-48-kavlan-4.nancy.grid5000.fr), Host(grisou-26-kavlan-4.nancy.grid5000.fr, address=grisou-26-kavlan-4.nancy.grid5000.fr)], 'chrony': [Host(grisou-47-kavlan-4.nancy.grid5000.fr, address=grisou-47-kavlan-4.nancy.grid5000.fr), Host(grisou-48-kavlan-4.nancy.grid5000.fr, address=grisou-48-kavlan-4.nancy.grid5000.fr), Host(grisou-26-kavlan-4.nancy.grid5000.fr, address=grisou-26-kavlan-4.nancy.grid5000.fr)], 'rally': [Host(grisou-47-kavlan-4.nancy.grid5000.fr, address=grisou-47-kavlan-4.nancy.grid5000.fr), Host(grisou-48-kavlan-4.nancy.grid5000.fr, address=grisou-48-kavlan-4.nancy.grid5000.fr), Host(grisou-26-kavlan-4.nancy.grid5000.fr, address=grisou-26-kavlan-4.nancy.grid5000.fr)], 'openstack': [Host(grisou-47-kavlan-4.nancy.grid5000.fr, address=grisou-47-kavlan-4.nancy.grid5000.fr), Host(grisou-48-kavlan-4.nancy.grid5000.fr, address=grisou-48-kavlan-4.nancy.grid5000.fr), Host(grisou-26-kavlan-4.nancy.grid5000.fr, address=grisou-26-kavlan-4.nancy.grid5000.fr)], 'sysbench': [Host(grisou-47-kavlan-4.nancy.grid5000.fr, address=grisou-47-kavlan-4.nancy.grid5000.fr), Host(grisou-48-kavlan-4.nancy.grid5000.fr, address=grisou-48-kavlan-4.nancy.grid5000.fr), Host(grisou-26-kavlan-4.nancy.grid5000.fr, address=grisou-26-kavlan-4.nancy.grid5000.fr)]}
DEBUG:root:[{'start': '10.16.26.0', 'end': '10.16.61.255', 'dns': '131.254.203.235', 'roles': ['database_network'], 'cidr': '10.16.0.0/18', 'gateway': '10.16.63.254'}, {'roles': ['control_network'], 'cidr': '172.16.64.0/20', 'gateway': '172.16.79.254', 'dns': '131.254.203.235'}]
#+END_EXAMPLE

- After deployment and emulate, trying to ping a node in the kavlan:
#+BEGIN_EXAMPLE
root@grisou-47-kavlan-4:~# ping grisou-48-kavlan-4
PING grisou-48-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.48) 56(84) bytes of data.
64 bytes from grisou-48-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.48): icmp_seq=1 ttl=64 time=40.1 ms
64 bytes from grisou-48-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.48): icmp_seq=2 ttl=64 time=40.0 ms
64 bytes from grisou-48-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.48): icmp_seq=3 ttl=64 time=40.0 ms
64 bytes from grisou-48-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.48): icmp_seq=4 ttl=64 time=40.0 mss
--- grisou-48-eth0-kavlan-4.nancy.grid5000.fr ping statistics ---
13 packets transmitted, 13 received, 0% packet loss, time 12012ms
rtt min/avg/max/mdev = 40.041/40.056/40.135/0.223 ms
#+END_EXAMPLE

- And control node:
#+BEGIN_EXAMPLE
root@grisou-47-kavlan-4:~# ping grisou-49
PING grisou-49.nancy.grid5000.fr (172.16.72.49) 56(84) bytes of data.
64 bytes from grisou-49.nancy.grid5000.fr (172.16.72.49): icmp_seq=1 ttl=63 time=40.0 ms
64 bytes from grisou-49.nancy.grid5000.fr (172.16.72.49): icmp_seq=2 ttl=63 time=40.0 ms
64 bytes from grisou-49.nancy.grid5000.fr (172.16.72.49): icmp_seq=3 ttl=63 time=40.0 ms
64 bytes from grisou-49.nancy.grid5000.fr (172.16.72.49): icmp_seq=4 ttl=63 time=40.0 ms
--- grisou-49.nancy.grid5000.fr ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3000ms
rtt min/avg/max/mdev = 40.054/40.062/40.072/0.141 ms
#+END_EXAMPLE

- Doesn't seem to take my constraint into account, but rather the ~default_delay~
- Confirmed when changing ~default_delay~ to 200ms:

#+BEGIN_EXAMPLE
root@grisou-47-kavlan-4:~# ping grisou-48-kavlan-4
PING grisou-48-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.48) 56(84) bytes of data.
64 bytes from grisou-48-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.48): icmp_seq=1 ttl=64 time=400 ms
64 bytes from grisou-48-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.48): icmp_seq=2 ttl=64 time=400 ms
--- grisou-48-eth0-kavlan-4.nancy.grid5000.fr ping statistics ---
3 packets transmitted, 2 received, 33% packet loss, time 2002ms
rtt min/avg/max/mdev = 400.065/400.079/400.093/0.014 ms
root@grisou-47-kavlan-4:~# ping grisou-49
PING grisou-49.nancy.grid5000.fr (172.16.72.49) 56(84) bytes of data.
64 bytes from grisou-49.nancy.grid5000.fr (172.16.72.49): icmp_seq=1 ttl=63 time=400 ms
64 bytes from grisou-49.nancy.grid5000.fr (172.16.72.49): icmp_seq=2 ttl=63 time=400 ms
64 bytes from grisou-49.nancy.grid5000.fr (172.16.72.49): icmp_seq=3 ttl=63 time=400 ms
--- grisou-49.nancy.grid5000.fr ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2001ms
rtt min/avg/max/mdev = 400.049/400.068/400.095/0.730 ms
#+END_EXAMPLE

- Moreover, as seen just above, and confirmed below, the delay is the same for every network
#+BEGIN_EXAMPLE
root@grisou-49:~# ping grisou-47-kavlan-4
PING grisou-47-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.47) 56(84) bytes of data.
64 bytes from grisou-47-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.47): icmp_seq=1 ttl=63 time=400 ms
64 bytes from grisou-47-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.47): icmp_seq=2 ttl=63 time=400 ms
64 bytes from grisou-47-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.47): icmp_seq=3 ttl=63 time=400 ms
--- grisou-47-eth0-kavlan-4.nancy.grid5000.fr ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2001ms
rtt min/avg/max/mdev = 400.045/400.055/400.068/0.516 ms
#+END_EXAMPLE

- And even worse, I don't know how could it work since there are no new nic activated:
#+BEGIN_EXAMPLE
root@grisou-47-kavlan-4:~# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth4: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 24:6e:96:03:0a:44 brd ff:ff:ff:ff:ff:ff
3: eth5: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 24:6e:96:03:0a:45 brd ff:ff:ff:ff:ff:ff
4: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc htb state UP group default qlen 1000
    link/ether 24:6e:96:03:0a:40 brd ff:ff:ff:ff:ff:ff
    inet 10.16.12.47/18 brd 10.16.63.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::266e:96ff:fe03:a40/64 scope link
       valid_lft forever preferred_lft forever
5: eth1: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 24:6e:96:03:0a:42 brd ff:ff:ff:ff:ff:ff
6: eth2: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether a0:36:9f:7e:4a:48 brd ff:ff:ff:ff:ff:ff
7: eth3: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether a0:36:9f:7e:4a:4a brd ff:ff:ff:ff:ff:ff
#+END_EXAMPLE

#+BEGIN_EXAMPLE
root@grisou-49:~# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth4: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 24:6e:96:03:0e:84 brd ff:ff:ff:ff:ff:ff
3: eth5: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 24:6e:96:03:0e:85 brd ff:ff:ff:ff:ff:ff
4: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc htb state UP group default qlen 1000
    link/ether 24:6e:96:03:0e:80 brd ff:ff:ff:ff:ff:ff
    inet 172.16.72.49/20 brd 172.16.79.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::266e:96ff:fe03:e80/64 scope link
       valid_lft forever preferred_lft forever
5: eth1: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 24:6e:96:03:0e:82 brd ff:ff:ff:ff:ff:ff
6: eth2: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether a0:36:9f:7e:4d:cc brd ff:ff:ff:ff:ff:ff
7: eth3: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether a0:36:9f:7e:4d:ce brd ff:ff:ff:ff:ff:ff
#+END_EXAMPLE

- Digging to see where the constraints make a problem
  + ediff on constraints before and after merge saying no differences makes me think MAYBE the problem is here
  + modifying
    - results, on deployment:
#+BEGIN_EXAMPLE
changed: [grisou-26-kavlan-4.nancy.grid5000.fr] => (item=(62, {'loss': 0, 'target': '10.16.12.47', 'delay': '10ms', 'source': 'grisou-26-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-47-kavlan-4.nancy.grid5000.fr] => (item=(62, {'loss': 0, 'target': '10.16.12.47', 'delay': '10ms', 'source': 'grisou-47-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-48-kavlan-4.nancy.grid5000.fr] => (item=(63, {'loss': 0, 'target': '10.16.12.48', 'delay': '10ms', 'source': 'grisou-48-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-26-kavlan-4.nancy.grid5000.fr] => (item=(63, {'loss': 0, 'target': '10.16.12.48', 'delay': '10ms', 'source': 'grisou-26-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-47-kavlan-4.nancy.grid5000.fr] => (item=(63, {'loss': 0, 'target': '10.16.12.48', 'delay': '10ms', 'source': 'grisou-47-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-48-kavlan-4.nancy.grid5000.fr] => (item=(64, {'loss': 0, 'target': '10.16.12.26', 'delay': '10ms', 'source': 'grisou-48-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-26-kavlan-4.nancy.grid5000.fr] => (item=(64, {'loss': 0, 'target': '10.16.12.26', 'delay': '10ms', 'source': 'grisou-26-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-47-kavlan-4.nancy.grid5000.fr] => (item=(64, {'loss': 0, 'target': '10.16.12.26', 'delay': '10ms', 'source': 'grisou-47-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-48-kavlan-4.nancy.grid5000.fr] => (item=(65, {'loss': '0', 'target': '10.16.12.47', 'delay': '200ms', 'source': 'grisou-48-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-26-kavlan-4.nancy.grid5000.fr] => (item=(65, {'loss': '0', 'target': '10.16.12.47', 'delay': '200ms', 'source': 'grisou-26-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-47-kavlan-4.nancy.grid5000.fr] => (item=(65, {'loss': '0', 'target': '10.16.12.47', 'delay': '200ms', 'source': 'grisou-47-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-48-kavlan-4.nancy.grid5000.fr] => (item=(66, {'loss': '0', 'target': '10.16.12.48', 'delay': '200ms', 'source': 'grisou-48-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-26-kavlan-4.nancy.grid5000.fr] => (item=(66, {'loss': '0', 'target': '10.16.12.48', 'delay': '200ms', 'source': 'grisou-26-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-47-kavlan-4.nancy.grid5000.fr] => (item=(66, {'loss': '0', 'target': '10.16.12.48', 'delay': '200ms', 'source': 'grisou-47-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-48-kavlan-4.nancy.grid5000.fr] => (item=(67, {'loss': '0', 'target': '10.16.12.26', 'delay': '200ms', 'source': 'grisou-48-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-26-kavlan-4.nancy.grid5000.fr] => (item=(67, {'loss': '0', 'target': '10.16.12.26', 'delay': '200ms', 'source': 'grisou-26-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
changed: [grisou-47-kavlan-4.nancy.grid5000.fr] => (item=(67, {'loss': '0', 'target': '10.16.12.26', 'delay': '200ms', 'source': 'grisou-47-kavlan-4.nancy.grid5000.fr', 'rate': '1gbit', 'device': 'eth0'}))
#+END_EXAMPLE
    - results for ping:
#+BEGIN_EXAMPLE
root@grisou-47-kavlan-4:~# ping grisou-48-kavlan-4
PING grisou-48-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.48) 56(84) bytes of data.
64 bytes from grisou-48-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.48): icmp_seq=1 ttl=64 time=400 ms
64 bytes from grisou-48-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.48): icmp_seq=2 ttl=64 time=400 ms
64 bytes from grisou-48-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.48): icmp_seq=3 ttl=64 time=400 ms
64 bytes from grisou-48-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.48): icmp_seq=4 ttl=64 time=400 ms
--- grisou-48-eth0-kavlan-4.nancy.grid5000.fr ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3002ms
rtt min/avg/max/mdev = 400.046/400.065/400.095/0.447 ms
root@grisou-47-kavlan-4:~# ping grisou-49
PING grisou-49.nancy.grid5000.fr (172.16.72.49) 56(84) bytes of data.
64 bytes from grisou-49.nancy.grid5000.fr (172.16.72.49): icmp_seq=1 ttl=63 time=20.6 ms
64 bytes from grisou-49.nancy.grid5000.fr (172.16.72.49): icmp_seq=2 ttl=63 time=20.0 ms
64 bytes from grisou-49.nancy.grid5000.fr (172.16.72.49): icmp_seq=3 ttl=63 time=20.0 ms
64 bytes from grisou-49.nancy.grid5000.fr (172.16.72.49): icmp_seq=4 ttl=63 time=20.0 ms
--- grisou-49.nancy.grid5000.fr ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3000ms
rtt min/avg/max/mdev = 20.053/20.215/20.684/0.305 ms
root@grisou-49:~# ping grisou-47-kavlan-4
PING grisou-47-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.47) 56(84) bytes of data.
64 bytes from grisou-47-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.47): icmp_seq=1 ttl=63 time=20.0 ms
64 bytes from grisou-47-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.47): icmp_seq=2 ttl=63 time=20.0 ms
64 bytes from grisou-47-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.47): icmp_seq=3 ttl=63 time=20.0 ms
64 bytes from grisou-47-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.47): icmp_seq=4 ttl=63 time=20.0 ms
64 bytes from grisou-47-eth0-kavlan-4.nancy.grid5000.fr (10.16.12.47): icmp_seq=5 ttl=63 time=20.0 ms
--- grisou-47-eth0-kavlan-4.nancy.grid5000.fr ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4004ms
rtt min/avg/max/mdev = 20.039/20.056/20.072/0.179 ms
#+END_EXAMPLE

- Everything seems ok, I switch =control_network= to =database_network= when necessary
  + tiny mighty problem here, had to add =hostvars[chrony_server]['control_network']= since I didn't have =control_network= on the other network nodes.


- Ran cockroachdb and mariadb rally on one node


* Wednesday 7 March [2018-03-07 mer.]

- Doing cockroachDB 5 nodes experiment
  + After 3 hours, not half of the tasks are finished :(
  + We looked with Ronan how to put CockroachDB in Snapshot Isolation mode (by befault it is in Serializable, which is the strongest level of isolation)
    - he found [[https://www.cockroachlabs.com/docs/stable/set-transaction.html#set-sessions-default-isolation][this link]]

- Took almost 8 hours from deploy to backup, but it worked "fine"
  + will try with MariaDB and then I will retry with SI


* Friday 9 March [2018-03-09 ven.]

- Deploying and testing on MariaDB
  - A lot quicker but loads of exit(201)
#+BEGIN_EXAMPLE
1f0a52039c09        beyondtheclouds/xrally-openstack   "rally task start /h…"   54 seconds ago           Exited (0) 43 seconds ago                                                                                                     create-and-delete-ec2credential.yaml-10-51-19

5dcb4bda0796        beyondtheclouds/xrally-openstack   "rally task start /h…"   About a minute ago       Exited (0) 55 seconds ago                                                                                                                    create-and-delete-role.yaml-10-50-57

aa5530376ac2        beyondtheclouds/xrally-openstack   "rally task start /h…"   About a minute ago       Exited (0) About a minute ago                                                                                                                create-and-list-tenants.yaml-10-50-36

38d99815c4a1        beyondtheclouds/xrally-openstack   "rally task start /h…"   About a minute ago       Exited (201) About a minute ago                                                                                                              get-entities.yaml-10-50-31

fae82f6e2b2a        beyondtheclouds/xrally-openstack   "rally task start /h…"   About a minute ago       Exited (201) About a minute ago                                                                                                              create-and-get-role.yaml-10-50-26

e997e5f30414        beyondtheclouds/xrally-openstack   "rally task start /h…"   About a minute ago       Exited (201) About a minute ago                                                                                                              create-and-list-services.yaml-10-50-20

62723142f662        beyondtheclouds/xrally-openstack   "rally task start /h…"   About a minute ago       Exited (201) About a minute ago                                                                                                              create-and-delete-service.yaml-10-50-16

a8398eb1eab6        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 minutes ago            Exited (201) About a minute ago                                                                                                              create-add-and-list-user-roles.yaml-10-50-11

41562e719da1        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 minutes ago            Exited (2) 2 minutes ago                                                                                                                     create-user-set-enabled-and-delete.yaml-10-49-38

2e237ca67c4f        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 minutes ago            Exited (201) 2 minutes ago                                                                                                                   create-tenant-with-users.yaml-10-49-34

9becf72fcde8        beyondtheclouds/xrally-openstack   "rally task start /h…"   2 minutes ago            Exited (2) 2 minutes ago                                                                                                                     authenticate-user-and-validate-token.yaml-10-49-25

8a8d2ee1dfe3        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 minutes ago            Exited (0) 2 minutes ago                                                                                                                     create-user.yaml-10-48-46

ae435eb72a41        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 minutes ago            Exited (201) 3 minutes ago                                                                                                                   create-and-list-users.yaml-10-48-42

409d9e75cb41        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 minutes ago            Exited (201) 3 minutes ago                                                                                                                   create-and-update-user.yaml-10-48-37

71649a2b8358        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 minutes ago            Exited (201) 3 minutes ago                                                                                                                   create-and-delete-user.yaml-10-48-32

8bdbd9c7171f        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 minutes ago            Exited (201) 3 minutes ago                                                                                                                   add-and-remove-user-role.yaml-10-48-27

5ac19fe7258e        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 minutes ago            Exited (201) 3 minutes ago                                                                                                                   create-and-list-roles.yaml-10-48-23

2a3ebafd93e3        beyondtheclouds/xrally-openstack   "rally task start /h…"   3 minutes ago            Exited (201) 3 minutes ago                                                                                                                   create-user-update-password.yaml-10-48-17

b9e7c3cdaf4e        beyondtheclouds/xrally-openstack   "rally task start /h…"   4 minutes ago            Exited (201) 3 minutes ago                                                                                                                   create-update-and-delete-tenant.yaml-10-48-12

d1ca9e67530c        beyondtheclouds/xrally-openstack   "rally task start /h…"   4 minutes ago            Exited (201) 4 minutes ago                                                                                                                   create-and-list-ec2credentials.yaml-10-48-07

0a25ae9f0d9b        beyondtheclouds/xrally-openstack   "rally task start /h…"   4 minutes ago            Exited (0) 4 minutes ago                                                                                                                     create-tenant.yaml-10-47-43
#+END_EXAMPLE
  + Also, collectd doesn't work anymore

- Inspecting keystone logs to search for the reason to all these exits
#+BEGIN_EXAMPLE
[None req-df051494-0e21-40d4-a830-2025bdfdbb94 None None] (_mysql_exceptions.OperationalError) (1213, 'Deadlock: wsrep aborted transaction'): OperationalError: (_mysql_exceptions.OperationalError) (1213
mon.wsgi Traceback (most recent call last):
mon.wsgi   File "/opt/stack/keystone/keystone/common/wsgi.py", line 228, in __call__
mon.wsgi     result = method(req, **params)
mon.wsgi   File "/opt/stack/keystone/keystone/common/controller.py", line 94, in inner
mon.wsgi     return f(self, request, *args, **kwargs)
mon.wsgi   File "/opt/stack/keystone/keystone/resource/controllers.py", line 269, in create_project
mon.wsgi     initiator=request.audit_initiator)
mon.wsgi   File "/opt/stack/keystone/keystone/common/manager.py", line 110, in wrapped
mon.wsgi     __ret_val = __f(*args, **kwargs)
mon.wsgi   File "/opt/stack/keystone/keystone/resource/core.py", line 208, in create_project
mon.wsgi     ret = self.driver.create_project(project_id, project)
mon.wsgi   File "/opt/stack/keystone/keystone/common/sql/core.py", line 505, in wrapper
mon.wsgi     return method(*args, **kwargs)
mon.wsgi   File "/opt/stack/oslo.db/oslo_db/api.py", line 150, in wrapper
mon.wsgi     ectxt.value = e.inner_exc
mon.wsgi   File "/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py", line 220, in __exit__
mon.wsgi     self.force_reraise()
mon.wsgi   File "/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py", line 196, in force_reraise
mon.wsgi     six.reraise(self.type_, self.value, self.tb)
mon.wsgi   File "/opt/stack/oslo.db/oslo_db/api.py", line 138, in wrapper
mon.wsgi     return f(*args, **kwargs)
mon.wsgi   File "/opt/stack/keystone/keystone/resource/backends/sql.py", line 183, in create_project
mon.wsgi     return project_ref.to_dict()
mon.wsgi   File "/usr/lib/python2.7/contextlib.py", line 24, in __exit__
mon.wsgi     self.gen.next()
mon.wsgi   File "/opt/stack/oslo.db/oslo_db/sqlalchemy/enginefacade.py", line 1029, in _transaction_scope
mon.wsgi     yield resource
mon.wsgi   File "/usr/lib/python2.7/contextlib.py", line 24, in __exit__
mon.wsgi     self.gen.next()
mon.wsgi   File "/opt/stack/oslo.db/oslo_db/sqlalchemy/enginefacade.py", line 641, in _session
mon.wsgi     self.session.rollback()
mon.wsgi   File "/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py", line 220, in __exit__
mon.wsgi     self.force_reraise()
mon.wsgi   File "/usr/local/lib/python2.7/dist-packages/oslo_utils/excutils.py", line 196, in force_reraise
mon.wsgi     six.reraise(self.type_, self.value, self.tb)
mon.wsgi   File "/opt/stack/oslo.db/oslo_db/sqlalchemy/enginefacade.py", line 638, in _session
mon.wsgi     self._end_session_transaction(self.session)
mon.wsgi   File "/opt/stack/oslo.db/oslo_db/sqlalchemy/enginefacade.py", line 666, in _end_session_transaction
mon.wsgi     session.commit()
mon.wsgi   File "/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py", line 906, in commit
mon.wsgi     self.transaction.commit()
mon.wsgi   File "/usr/local/lib/python2.7/dist-packages/sqlalchemy/orm/session.py", line 465, in commit
mon.wsgi     t[1].commit()
mon.wsgi   File "/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py", line 1632, in commit
mon.wsgi     self._do_commit()
mon.wsgi   File "/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py", line 1663, in _do_commit
mon.wsgi     self.connection._commit_impl()
mon.wsgi   File "/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py", line 723, in _commit_impl
mon.wsgi     self._handle_dbapi_exception(e, None, None, None, None)
mon.wsgi   File "/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py", line 1398, in _handle_dbapi_exception
mon.wsgi     util.raise_from_cause(newraise, exc_info)
mon.wsgi   File "/usr/local/lib/python2.7/dist-packages/sqlalchemy/util/compat.py", line 203, in raise_from_cause
mon.wsgi     reraise(type(exception), exception, tb=exc_tb, cause=cause)
mon.wsgi   File "/usr/local/lib/python2.7/dist-packages/sqlalchemy/engine/base.py", line 721, in _commit_impl
mon.wsgi     self.engine.dialect.do_commit(self.connection)
mon.wsgi   File "/usr/local/lib/python2.7/dist-packages/sqlalchemy/dialects/mysql/base.py", line 1586, in do_commit
mon.wsgi     dbapi_connection.commit()
mon.wsgi OperationalError: (_mysql_exceptions.OperationalError) (1213, 'Deadlock: wsrep aborted transaction')
#+END_EXAMPLE
- Trying to correct that by adding on [[https://github.com/BeyondTheClouds/oslo.db/blob/cockroachdb/pike/oslo_db/sqlalchemy/exc_filters.py#L60][this line]]:
#+BEGIN_SRC
@filters("mysql", sqla_exc.OperationalError, r"^.*\b1213\b.*Deadlock*")
#+END_SRC


- Trying to put tc in config
  + using in conf.yaml (thanks to [[http://pyyaml.org/wiki/PyYAMLDocumentation#YAMLsyntax][yaml documentation]]):
#+BEGIN_EXAMPLE
tc:
  enable: True
  default_delay: 0ms
  default_rate: 10gbit
  constraints:
    - src: database
      dst: database
      delay: 0ms
      rate: 10gbit
      loss: 0
#+END_EXAMPLE
  + testing syntax using a little function (since I'm not sure how yaml works)
    #+BEGIN_SRC python
@doc()
def test_lol(**kwargs):
    """
usage: juice test_lol

Testing yaml config
    """
    bidule = {}
    with open("./conf.yaml") as f:
        bidule = yaml.load(f)
    print(bidule)
    #+END_SRC
    #+BEGIN_EXAMPLE
    (venv) madelavergne@frennes:~/juice$ ./juice.py test_lol
{'g5k': {'dhcp': True, 'walltime': '09:00:00', 'job_name': 'juice-tests', 'resources': {'networks': [{'type': 'kavlan', 'id': 'n1', 'roles': ['database_network'], 'site': 'nancy'}, {'type': 'prod', 'id': 'n2', 'roles': ['control_network'], 'site': 'nancy'}], 'machines': [{'cluster': 'grisou', 'nodes': 5, 'roles': ['chrony', 'database', 'sysbench', 'openstack', 'rally'], 'primary_network': 'n1', 'secondary_networks': ['n2']}, {'cluster': 'grisou', 'nodes': 1, 'roles': ['control'], 'primary_network': 'n2', 'secondary_networks': []}]}, 'env_name': 'debian9-x64-nfs'}, 'registry': {'type': 'none'}, 'tc': {'default_rate': '10gbit', 'enable': True, 'default_delay': '0ms', 'constraints': [{'delay': '0ms', 'src': 'database', 'dst': 'database', 'rate': '10gbit', 'loss': 0}]}}
    #+END_EXAMPLE
  + comparing to
#+BEGIN_EXAMPLE
INFO:root:Emulates using constraints: {'default_rate': '10gbit', 'enable': True, 'default_delay': '0ms', 'constraints': [{'delay': '0ms', 'src': 'database', 'dst': 'database', 'rate': '10gbit', 'loss': '0'}]}
#+END_EXAMPLE
  + seems ok


(venv) madelavergne@frennes:~/juice$ ./juice.py emulate
DEBUG:root:Loaded environment current/env
INFO:root:- Task emulate started -
Traceback (most recent call last):
  File "./juice.py", line 354, in <module>
    doc_lookup(args['<command>'], argv)
  File "/home/madelavergne/juice/utils/doc.py", line 29, in doc_lookup
    return fn(**docopt(fn.__doc__, argv=argv))
  File "/home/madelavergne/juice/utils/doc.py", line 18, in decorated
    fn(*args, **kwargs)
  File "/home/madelavergne/juice/venv/local/lib/python2.7/site-packages/enoslib/task.py", line 50, in decorated
    fn(*args, **kwargs)
  File "./juice.py", line 226, in emulate
    logging.info("Emulates using constraints: %s" % tc)
UnboundLocalError: local variable 'tc' referenced before assignment

- Ran keystone/create-and-delete-service.yaml
  + with delay = 0 ms
#+BEGIN_EXAMPLE
--------------------------------------------------------------------------------
Task 5659b84c-1c94-4c28-9a59-72fa61b3c1f6: finished
--------------------------------------------------------------------------------

test scenario KeystoneBasic.create_and_delete_service
args position 0
args values:
{
  "runner": {
    "times": 100,
    "concurrency": 10
  },
  "contexts": {},
  "args": {
    "service_type": "Rally_test_type",
    "description": "test_description"
  },
  "sla": {
    "failure_rate": {
      "max": 0
    }
  },
  "hooks": []
}

--------------------------------------------------------------------------------
Task 5659b84c-1c94-4c28-9a59-72fa61b3c1f6 has 0 error(s)
--------------------------------------------------------------------------------

+-------------------------------------------------------------------------------------------------------------------------------+
|                                                     Response Times (sec)                                                      |
+----------------------------+-----------+--------------+--------------+--------------+-----------+-----------+---------+-------+
| Action                     | Min (sec) | Median (sec) | 90%ile (sec) | 95%ile (sec) | Max (sec) | Avg (sec) | Success | Count |
+----------------------------+-----------+--------------+--------------+--------------+-----------+-----------+---------+-------+
| keystone_v3.create_service | 0.918     | 5.296        | 8.868        | 9.558        | 13.008    | 5.406     | 100.0%  | 100   |
| keystone_v3.delete_service | 0.917     | 2.742        | 5.784        | 8.085        | 20.186    | 3.806     | 100.0%  | 100   |
| total                      | 2.029     | 8.457        | 14.489       | 18.813       | 32.772    | 9.212     | 100.0%  | 100   |
|  -> duration               | 2.029     | 8.457        | 14.489       | 18.813       | 32.772    | 9.212     | 100.0%  | 100   |
|  -> idle_duration          | 0.0       | 0.0          | 0.0          | 0.0          | 0.0       | 0.0       | 100.0%  | 100   |
+----------------------------+-----------+--------------+--------------+--------------+-----------+-----------+---------+-------+

Load duration: 185.855062
Full duration: 198.091952

HINTS:
 To plot HTML graphics with this data, run:
	rally task report 5659b84c-1c94-4c28-9a59-72fa61b3c1f6 --out output.html

 To generate a JUnit report, run:
	rally task export 5659b84c-1c94-4c28-9a59-72fa61b3c1f6 --type junit --to output.xml

 To get raw JSON output of task results, run:
	rally task report 5659b84c-1c94-4c28-9a59-72fa61b3c1f6 --json --out output.json

#+END_EXAMPLE
+ with delay = 150 ms
#+BEGIN_EXAMPLE
--------------------------------------------------------------------------------
Task de1aeed6-2d28-4cc2-b23c-9389208a39c2 has 0 error(s)
--------------------------------------------------------------------------------

+-------------------------------------------------------------------------------------------------------------------------------+
|                                                     Response Times (sec)                                                      |
+----------------------------+-----------+--------------+--------------+--------------+-----------+-----------+---------+-------+
| Action                     | Min (sec) | Median (sec) | 90%ile (sec) | 95%ile (sec) | Max (sec) | Avg (sec) | Success | Count |
+----------------------------+-----------+--------------+--------------+--------------+-----------+-----------+---------+-------+
| keystone_v3.create_service | 5.52      | 29.325       | 50.627       | 55.908       | 69.456    | 30.975    | 100.0%  | 100   |
| keystone_v3.delete_service | 2.389     | 18.207       | 32.409       | 42.02        | 84.625    | 19.839    | 100.0%  | 100   |
| total                      | 14.97     | 51.08        | 70.633       | 79.335       | 144.938   | 50.814    | 100.0%  | 100   |
|  -> duration               | 14.97     | 51.08        | 70.633       | 79.335       | 144.938   | 50.814    | 100.0%  | 100   |
|  -> idle_duration          | 0.0       | 0.0          | 0.0          | 0.0          | 0.0       | 0.0       | 100.0%  | 100   |
+----------------------------+-----------+--------------+--------------+--------------+-----------+-----------+---------+-------+

Load duration: 1159.723045
Full duration: 1444.718275

#+END_EXAMPLE
